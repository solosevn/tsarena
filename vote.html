<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enter the Arena | The Safety Arena</title>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- FingerprintJS v4 -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg-dark: #060d1a;
    --bg-card: #0c1829;
    --bg-card-hover: #111f35;
    --cyan: #00e5ff;
    --cyan-dim: #00acc1;
    --cyan-glow: rgba(0, 229, 255, 0.15);
    --orange: #ff6d00;
    --red: #ff1744;
    --green: #00e676;
    --text-primary: #e8eaed;
    --text-secondary: #90a4ae;
    --text-dim: #546e7a;
    --border: #1a2a3a;
  }

  body {
    background: var(--bg-dark);
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, sans-serif;
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* ===== TICKER BARS ===== */
  .ticker-wrap {
    width: 100%;
    overflow: hidden;
    height: 36px;
    background: linear-gradient(90deg, rgba(0,229,255,0.08), rgba(0,229,255,0.03), rgba(0,229,255,0.08));
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
  }
  .ticker-wrap.arena-ticker {
    background: linear-gradient(90deg, rgba(255,109,0,0.08), rgba(255,109,0,0.03), rgba(255,109,0,0.08));
  }
  .ticker-label {
    flex-shrink: 0;
    padding: 0 16px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    border-right: 1px solid var(--border);
    height: 100%;
    display: flex;
    align-items: center;
    background: #0d0d14;
    position: relative;
    z-index: 2;
  }
  .ticker-label.trs { color: var(--cyan); }
  .ticker-label.arena { color: var(--orange); }
  .ticker-logo { width: 20px; height: 20px; border-radius: 3px; object-fit: contain; flex-shrink: 0; vertical-align: middle; }

  .ticker-track {
    display: flex;
    animation: scroll-left 40s linear infinite;
    white-space: nowrap;
  }
  .arena-ticker .ticker-track { animation-duration: 35s; }

  @keyframes scroll-left {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 0 24px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    flex-shrink: 0;
  }
  .ticker-item .rank { color: #e8e8f0; font-size: 13px; font-weight: 400; }
  .ticker-item .model { color: var(--text-primary); font-weight: 600; }
  .ticker-item .score { color: var(--cyan); font-weight: 700; font-family: 'Space Grotesk', monospace; }
  .arena-ticker .ticker-item .score { color: var(--orange); }
  .ticker-item .change-up { color: var(--green); font-size: 11px; }
  .ticker-item .change-down { color: var(--red); font-size: 11px; }
  .ticker-item .sep { color: var(--border); margin: 0 4px; }

  /* ===== HEADER ===== */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 40px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-dark);
    backdrop-filter: blur(12px);
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .logo-mark {
    width: 52px;
    height: 52px;
    flex-shrink: 0;
  }
  .logo-text {
    display: flex;
    flex-direction: column;
  }
  .logo-text .brand {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: -0.5px;
    line-height: 1.1;
  }
  .logo-text .brand span { color: var(--cyan); }
  .logo-text .sub {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 2px;
  }
  .logo-text .sub a {
    color: var(--cyan-dim);
    text-decoration: none;
  }
  .logo-text .sub a:hover { text-decoration: underline; }

  .header-nav {
    display: flex;
    align-items: center;
    gap: 28px;
  }
  .header-nav a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: color 0.2s;
  }
  .header-nav a:hover { color: var(--cyan); }
  .header-nav .btn-vote {
    background: var(--cyan);
    color: var(--bg-dark);
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.2s;
    text-decoration: none;
  }
  .header-nav .btn-vote:hover {
    background: #33ecff;
    box-shadow: 0 0 20px rgba(0,229,255,0.3);
    color: var(--bg-dark);
  }

  /* ===== HERO ===== */
  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: rgba(0, 229, 255, 0.1);
    border: 1px solid rgba(0, 229, 255, 0.25);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--cyan);
  }
  .user-email {
    font-size: 13px;
    color: var(--text-secondary);
  }
  .logout-btn {
    font-size: 12px;
    color: var(--text-dim);
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
    background: none;
    border: none;
    padding: 0;
  }
  .logout-btn:hover { color: var(--red); }

  /* ===== AUTH MODAL ===== */
  .auth-modal-overlay {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(6, 13, 26, 0.95);
    backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .auth-modal {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }
  .auth-modal h2 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .auth-modal p {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 28px;
  }
  .auth-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }
  .auth-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
  }
  .auth-tab.active {
    color: var(--cyan);
    border-bottom-color: var(--cyan);
  }
  .auth-form {
    display: none;
  }
  .auth-form.active {
    display: block;
  }
  .auth-form-group {
    margin-bottom: 16px;
  }
  .auth-form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }
  .auth-form-group input {
    width: 100%;
    padding: 10px 14px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: border-color 0.2s;
  }
  .auth-form-group input:focus {
    outline: none;
    border-color: var(--cyan);
  }
  .auth-btn {
    width: 100%;
    padding: 12px;
    background: var(--cyan);
    color: var(--bg-dark);
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 12px;
  }
  .auth-btn:hover {
    background: #33ecff;
    box-shadow: 0 0 20px rgba(0,229,255,0.3);
  }
  .auth-btn.google {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  .auth-btn.google:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--text-secondary);
  }

    .auth-btn.twitter {
      background: #000000;
      border: 1px solid #333;
      color: white;
    }

    .auth-btn.twitter:hover {
      background: #1a1a1a;
    }

    .tos-group { margin-top: 12px; }
    .tos-label { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: var(--text-secondary); cursor: pointer; line-height: 1.4; }
    .tos-label input[type='checkbox'] { margin-top: 3px; accent-color: var(--cyan); cursor: pointer; flex-shrink: 0; }
    .tos-label a { color: var(--cyan); text-decoration: none; }
    .tos-label a:hover { text-decoration: underline; }
  .auth-error {
    padding: 12px;
    background: rgba(255, 23, 68, 0.1);
    border: 1px solid var(--red);
    border-radius: 8px;
    color: var(--red);
    font-size: 13px;
    margin-bottom: 16px;
    display: none;
  }
  .auth-loading {
    display: none;
    text-align: center;
    color: var(--text-secondary);
    font-size: 14px;
  }

  /* ===== ARENA CONTAINER ===== */
  .arena-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: clamp(16px, 3vw, 40px);
  }

  /* ===== BATTLE HEADER ===== */
  .battle-header {
    text-align: center;
    margin-bottom: 32px;
  }
  .battle-count {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,109,0,0.1);
    border: 1px solid rgba(255,109,0,0.25);
    border-radius: 100px;
    padding: 6px 18px;
    font-size: 12px;
    font-weight: 700;
    color: var(--orange);
    margin-bottom: 16px;
    letter-spacing: 0.5px;
  }
  .battle-count .live-dot {
    width: 6px;
    height: 6px;
    background: var(--orange);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .battle-header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: clamp(20px, 2.5vw, 28px);
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 8px;
  }
  .battle-header p {
    color: var(--text-secondary);
    font-size: clamp(13px, 1.2vw, 15px);
  }

  /* ===== ENGAGEMENT TIMER ===== */
  .engagement-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    padding: 12px 16px;
    background: rgba(255, 109, 0, 0.08);
    border: 1px solid rgba(255, 109, 0, 0.2);
    border-radius: 8px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  .timer-countdown {
    font-family: 'Space Grotesk', monospace;
    font-weight: 700;
    color: var(--orange);
  }

  /* ===== SCENARIO PROMPT ===== */
  .scenario {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px 32px;
    margin-bottom: 28px;
  }
  .scenario-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 700;
    color: var(--orange);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 14px;
  }
  .scenario-label svg { flex-shrink: 0; }
  .scenario-text {
    font-size: clamp(14px, 1.3vw, 16px);
    line-height: 1.7;
    color: var(--text-primary);
    font-weight: 400;
  }
  .scenario-category {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 14px;
    padding: 4px 12px;
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.15);
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    color: var(--cyan);
    letter-spacing: 0.5px;
  }

  /* ===== RESPONSE COLUMNS ===== */
  .responses {
    display: grid;
    grid-template-columns: 1fr 48px 1fr;
    gap: 0;
    align-items: stretch;
    margin-bottom: 28px;
  }
  .battle-container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: stretch;
  }
  .response-card {
    flex: 1;
    min-width: 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    display: flex;
    flex-direction: column;
    transition: all 0.3s;
    cursor: default;
  }
  .response-card:hover {
    border-color: rgba(0,229,255,0.2);
  }
  .response-card.selected {
    border-color: var(--cyan);
    box-shadow: 0 0 30px rgba(0,229,255,0.15);
  }

  .response-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .response-label .tag {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .response-label .tag .icon {
    width: 36px;
    height: 36px;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.25);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  .response-label .anon {
    font-size: 12px;
    color: var(--text-dim);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .response-label .anon svg { opacity: 0.5; }

  .response-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.75;
    color: var(--text-secondary);
  }
  .response-text p { margin-bottom: 12px; }
  .response-text p:last-child { margin-bottom: 0; }

  /* VS divider */
  .vs-divider {
    flex-shrink: 0;
    flex-direction: column;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .vs-badge {
    width: 44px;
    height: 44px;
    background: var(--bg-dark);
    border: 2px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 13px;
    font-weight: 800;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  /* ===== VOTE BUTTONS ===== */
  .vote-section {
    display: block;
    margin-bottom: 20px;
  }
  .vote-buttons {
    display: flex;
    flex-direction: row;
    align-items: center;
  }
  .vote-col {
    flex: 1;
    display: flex;
    justify-content: center;
  }
  .vote-col-tie {
    flex-shrink: 0;
    width: 44px;
    display: flex;
    justify-content: center;
  }
  .vote-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px 32px;
    border-radius: 12px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.25s;
    border: 2px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    text-decoration: none;
  }
  .vote-btn:hover:not(:disabled) {
    border-color: var(--cyan);
    background: rgba(0,229,255,0.06);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,229,255,0.12);
  }
  .vote-btn:active:not(:disabled) {
    transform: translateY(0);
  }
  .vote-btn.selected {
    border-color: var(--cyan);
    background: rgba(0,229,255,0.12);
    color: var(--cyan);
    box-shadow: 0 0 30px rgba(0,229,255,0.15);
  }
  .vote-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .vote-btn .check { display: none; }
  .vote-btn.selected .check { display: inline; }

  .vote-tie {
    display: flex;
    justify-content: center;
  }
  .vote-btn-tie {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 32px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    text-decoration: none;
  }
  .vote-btn-tie:hover:not(:disabled) {
    border-color: var(--text-secondary);
    color: var(--text-secondary);
    background: rgba(255,255,255,0.03);
  }
  .vote-btn-tie:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ===== VOTE EXPLANATION TEXTAREA ===== */
  .vote-explanation {
    display: none;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    animation: slideDown 0.3s ease;
  }
  .vote-explanation.show {
    display: block;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .vote-explanation label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .vote-explanation textarea {
    width: 100%;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
  }
  .vote-explanation textarea:focus {
    outline: none;
    border-color: var(--cyan);
  }
  .word-counter {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .word-count {
    font-family: 'Space Grotesk', monospace;
    font-weight: 600;
  }
  .word-count.valid {
    color: var(--green);
  }
  .word-count.invalid {
    color: var(--red);
  }
  .submit-vote-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: var(--cyan);
    color: var(--bg-dark);
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 12px;
  }
  .submit-vote-btn:hover:not(:disabled) {
    background: #33ecff;
    box-shadow: 0 0 20px rgba(0,229,255,0.3);
  }
  .submit-vote-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .submit-vote-btn.submitting {
    background: #0099b3;
    pointer-events: none;
    position: relative;
  }
  .submit-vote-btn.submitting::after {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(10,10,15,0.3);
    border-top-color: #0a0a0f;
    border-radius: 50%;
    animation: spinBtn 0.6s linear infinite;
    margin-left: 8px;
    vertical-align: middle;
  }
  @keyframes spinBtn {
    to { transform: rotate(360deg); }
  }
  .submit-vote-btn.submitted {
    background: #00e676;
    color: #0a0a0f;
    pointer-events: none;
    animation: pulseSuccess 0.4s ease;
  }
  @keyframes pulseSuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  /* === NEW REVEAL CARDS === */
  .reveal-winner {
    background: linear-gradient(145deg, #0a2618 0%, #0c1829 40%, #0a2618 100%);
    border: 2px solid var(--green);
    border-radius: 20px;
    padding: 32px 36px;
    margin-bottom: 14px;
    position: relative;
    overflow: hidden;
    animation: revealGlow 2s ease-in-out infinite alternate;
  }
  @keyframes revealGlow {
    from { box-shadow: 0 0 25px rgba(0,230,118,0.15); }
    to { box-shadow: 0 0 40px rgba(0,230,118,0.3); }
  }
  .reveal-winner.pick-b {
    background: linear-gradient(145deg, #081828 0%, #0c1829 40%, #081828 100%);
    border-color: var(--cyan);
    animation: none;
    box-shadow: 0 0 35px rgba(0,229,255,0.2);
  }
  .reveal-badge {
    position: absolute; top: 0; right: 0;
    background: var(--green);
    color: #0a0a0f;
    font-weight: 800; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;
    padding: 8px 20px 8px 24px;
    border-radius: 0 18px 0 16px;
  }
  .reveal-winner.pick-b .reveal-badge { background: var(--cyan); }
  .reveal-top {
    display: flex; align-items: center; gap: 24px; margin-bottom: 16px;
  }
  .reveal-logo {
    width: 80px; height: 80px; border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; overflow: hidden;
  }
  .reveal-logo img {
    width: 64px; height: 64px; border-radius: 14px; object-fit: cover;
  }
  .reveal-model-name {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 28px; font-weight: 800; color: #fff; line-height: 1.1; margin-bottom: 4px;
  }
  .reveal-company {
    font-size: 20px; font-weight: 700; letter-spacing: 0.5px;
  }
  .reveal-winner .reveal-company { color: var(--green); }
  .reveal-winner.pick-b .reveal-company { color: var(--cyan); }
  .reveal-response-tag {
    font-size: 11px; color: rgba(255,255,255,0.4);
    text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 3px;
  }
  .reveal-stats {
    display: flex; gap: 28px; margin-top: 16px; padding-top: 16px;
    border-top: 1px solid rgba(0,230,118,0.15);
  }
  .reveal-winner.pick-b .reveal-stats { border-top-color: rgba(0,229,255,0.15); }
  .reveal-stat-val {
    font-size: 24px; font-weight: 800; color: #fff;
    font-family: 'Space Grotesk', sans-serif;
  }
  .reveal-stat-lbl {
    font-size: 10px; color: #546e7a; text-transform: uppercase;
    letter-spacing: 1px; margin-top: 2px;
  }
  .reveal-loser {
    background: var(--bg-card);
    border: 1px solid #1a2a3a;
    border-radius: 12px;
    padding: 16px 20px;
    opacity: 0.55;
    display: flex; align-items: center; gap: 14px;
  }
  .reveal-loser .reveal-logo {
    width: 48px; height: 48px; border-radius: 12px;
  }
  .reveal-loser .reveal-logo img {
    width: 36px; height: 36px; border-radius: 9px;
  }
  .reveal-loser .reveal-model-name {
    font-size: 16px; color: #90a4ae; margin-bottom: 1px;
  }
  .reveal-loser .reveal-company {
    font-size: 13px; color: #546e7a;
  }
  .reveal-loser .reveal-response-tag { font-size: 10px; }
  .reveal-loser-tag {
    margin-left: auto; font-size: 11px; color: #546e7a;
    text-transform: uppercase; letter-spacing: 1px; font-weight: 600; white-space: nowrap;
  }
  .reveal-community {
    margin-top: 20px; padding: 14px 18px;
    background: rgba(12,24,41,0.8);
    border: 1px solid #1a2a3a; border-radius: 10px;
  }
  .reveal-community-label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
    color: #546e7a; margin-bottom: 8px; font-weight: 600;
  }
  .reveal-bar-track {
    height: 7px; background: #1a2a3a; border-radius: 4px;
    overflow: hidden; display: flex;
  }
  .reveal-bar-a { background: var(--green); }
  .reveal-bar-tie { background: #ffd700; }
  .reveal-bar-b { background: var(--cyan); }
  .reveal-bar-labels {
    display: flex; justify-content: space-between;
    margin-top: 5px; font-size: 11px; font-weight: 600;
  }
  .reveal-bar-labels .rbl-a { color: var(--green); }
  .reveal-bar-labels .rbl-t { color: #ffd700; }
  .reveal-bar-labels .rbl-b { color: var(--cyan); }
  /* Tie reveal */
  .reveal-tie {
    background: linear-gradient(145deg, #1a1a0d 0%, #0c1829 40%, #1a1a0d 100%);
    border: 2px solid #ffd700; border-radius: 16px;
    padding: 20px 24px; margin-bottom: 10px;
    display: flex; align-items: center; gap: 18px;
    box-shadow: 0 0 20px rgba(255,215,0,0.08);
  }
  .reveal-tie .reveal-model-name { font-size: 22px; }
  .reveal-tie .reveal-company { color: #ffd700; font-size: 16px; }
  .reveal-tie-divider {
    text-align: center; padding: 3px 0;
  }
  .reveal-tie-divider span {
    background: #ffd700; color: #0a0a0f; font-weight: 800;
    font-size: 11px; padding: 4px 14px; border-radius: 20px; letter-spacing: 2px;
  }

  /* Hidden honeypot field */
  #honeypot-website {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    width: 0 !important;
    position: absolute !important;
    left: -9999px !important;
    opacity: 0 !important;
  }

  /* ===== PROGRESS / META BAR ===== */
  .meta-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-top: 1px solid var(--border);
    margin-top: 8px;
  }
  .meta-bar .progress-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .progress-track {
    width: 200px;
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--cyan);
    border-radius: 4px;
    width: 30%;
    transition: width 0.4s ease;
  }
  .meta-bar .progress-text {
    font-size: 13px;
    color: var(--text-dim);
    font-weight: 500;
  }
  .meta-bar .session-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .meta-bar .session-info span {
    font-size: 12px;
    color: var(--text-dim);
    font-weight: 500;
  }
  .votes-remaining {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: rgba(0, 229, 255, 0.08);
    border: 1px solid rgba(0, 229, 255, 0.15);
    border-radius: 6px;
    font-size: 12px;
    color: var(--cyan);
    font-weight: 600;
  }
  .skip-btn {
    font-size: 13px;
    color: var(--text-dim);
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
    background: none;
    border: none;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .skip-btn:hover { color: var(--text-secondary); }

  /* ===== RESULT REVEAL (hidden by default, shown after vote) ===== */
  .result-reveal {
    display: none;
    background: var(--bg-card);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 14px;
    padding: 28px 32px;
    margin-bottom: 28px;
    text-align: center;
  }
  .result-reveal.show { display: block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .result-reveal h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--cyan);
  }
  .result-reveal .models-revealed {
    display: flex;
    justify-content: center;
    gap: 48px;
    margin: 20px 0;
  }
  .revealed-model {
    text-align: center;
  }
  .revealed-model .label {
    font-size: 12px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .revealed-model .name {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
  }
  .revealed-model .lab {
    font-size: 13px;
    color: var(--text-dim);
  }
  .revealed-model.winner .name { color: var(--cyan); }
  .result-next-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    padding: 14px 36px;
    background: var(--cyan);
    color: var(--bg-dark);
    border: none;
    border-radius: 10px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  .result-next-btn:hover {
    background: #33ecff;
    box-shadow: 0 0 24px rgba(0,229,255,0.3);
    transform: translateY(-1px);
  }

  /* ===== FOOTER ===== */
  .footer {
    border-top: 1px solid var(--border);
    padding: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .footer-left { font-size: 13px; color: var(--text-dim); }
  .footer-left a { color: var(--cyan-dim); text-decoration: none; }
  .footer-right { display: flex; gap: 24px; }
  .footer-right a { color: var(--text-dim); text-decoration: none; font-size: 13px; font-weight: 500; }
  .footer-right a:hover { color: var(--cyan); }

  /* ===== RESPONSIVE: TABLET ===== */
  @media (max-width: 1024px) {
    .header { padding: 16px 24px; }
    .header-nav { gap: 20px; }
    .header-nav a { font-size: 13px; }
    .header-nav .btn-vote { padding: 8px 18px; font-size: 13px; }
    .logo-text .brand { font-size: 22px; }
    .logo-mark { width: 44px; height: 44px; }

    .scenario { padding: 22px 24px; }
    .response-card { padding: 22px; }
    .response-text { font-size: 13px; }
    .vote-btn { padding: 15px 24px; font-size: 15px; }
    .vote-btn-tie { padding: 10px 24px; font-size: 13px; }
  }

  /* ===== RESPONSIVE: MOBILE ===== */
  @media (max-width: 768px) {
    /* TICKER: Single arena ticker only, readable */
    .ticker-wrap:first-of-type { display: none; }
    .ticker-wrap.arena-ticker { height: 40px; }
    .ticker-wrap.arena-ticker .ticker-label { font-size: 10px; padding: 0 10px; }
    .ticker-wrap.arena-ticker .ticker-item { font-size: 14px; padding: 0 18px; }
    .ticker-wrap.arena-ticker .ticker-item .rank { font-size: 12px; }
    .ticker-wrap.arena-ticker .ticker-item .model { font-size: 14px; }
    .ticker-wrap.arena-ticker .ticker-item .score { font-size: 15px; }

    /* HEADER: Logo left, minimal nav */
    .header {
      padding: 8px 14px;
      flex-direction: row;
      gap: 0;
    }
    .header-left { gap: 8px; }
    .logo-mark { width: 30px; height: 30px; }
    .logo-text .brand { font-size: 16px; }
    .logo-text .sub { font-size: 8px; margin-top: 0; }
    .header-nav a { display: none; }
    .header-nav a[href="#leaderboard"] {
      display: inline;
      font-size: 13px;
      font-weight: 600;
      color: var(--cyan);
    }
    .header-nav .btn-vote { display: none; }
    .user-info { flex-direction: column; gap: 8px; align-items: flex-end; }
    .user-email { font-size: 11px; }
    .logout-btn { font-size: 11px; }

    /* ARENA CONTAINER */
    .arena-container { padding: 12px 14px; }

    /* BATTLE HEADER: Compact */
    .battle-header { margin-bottom: 12px; }
    .battle-count { font-size: 10px; padding: 4px 12px; margin-bottom: 8px; gap: 6px; }
    .battle-count .live-dot { width: 5px; height: 5px; }
    .battle-header h1 { font-size: 22px; margin-bottom: 4px; }
    .battle-header p { font-size: 13px; }

    /* ENGAGEMENT TIMER */
    .engagement-timer { font-size: 12px; margin-bottom: 14px; }

    /* SCENARIO: Compressed */
    .scenario { padding: 14px 16px; margin-bottom: 14px; border-radius: 10px; }
    .scenario-label { font-size: 10px; margin-bottom: 8px; letter-spacing: 1px; }
    .scenario-label svg { width: 13px; height: 13px; }
    .scenario-text { font-size: 14px; line-height: 1.5; }
    .scenario-category { font-size: 10px; margin-top: 10px; padding: 3px 10px; }

    /* RESPONSES: Stacked, shorter, scrollable */
    .responses { grid-template-columns: 1fr; gap: 10px; }
    .vs-divider { display: none; }
    .response-card {
      padding: 16px;
      border-radius: 10px;
      max-height: 220px;
      overflow-y: auto;
    }
    .response-label { margin-bottom: 12px; padding-bottom: 10px; }
    .response-label .tag { font-size: 15px; gap: 8px; }
    .response-label .tag .icon { width: 30px; height: 30px; font-size: 14px; border-radius: 6px; }
    .response-label .anon { font-size: 11px; }
    .response-text { font-size: 13px; line-height: 1.6; }
    .response-text p { margin-bottom: 8px; }

    /* VOTE BUTTONS: Side by side, compact */
    .vote-section { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .vote-btn { padding: 14px 12px; font-size: 13px; border-radius: 10px; gap: 6px; }

    /* VOTE EXPLANATION */
    .vote-explanation { padding: 14px; }
    .vote-explanation label { font-size: 12px; }
    .vote-explanation textarea { font-size: 13px; min-height: 70px; }
    .word-counter { font-size: 11px; }
    .submit-vote-btn { padding: 10px 20px; font-size: 13px; }

    /* TIE */
    .vote-tie { margin-bottom: 8px; }
    .vote-btn-tie { padding: 10px 20px; font-size: 12px; }

    /* META BAR */
    .meta-bar { flex-direction: column; gap: 12px; padding: 10px 0; margin-top: 4px; }
    .meta-bar .progress-info { gap: 8px; width: 100%; }
    .progress-track { width: 100%; height: 3px; }
    .meta-bar .progress-text { font-size: 11px; }
    .meta-bar .session-info { width: 100%; flex-direction: column; gap: 8px; align-items: flex-start; }
    .meta-bar .session-info span { font-size: 11px; }
    .skip-btn { font-size: 11px; }
    .votes-remaining { font-size: 11px; }

    /* RESULT REVEAL */
    .result-reveal { padding: 20px; border-radius: 10px; margin-bottom: 14px; }
    .result-reveal h3 { font-size: 18px; }
    .result-reveal .models-revealed { gap: 20px; margin: 14px 0; }
    .revealed-model .name { font-size: 16px; }
    .revealed-model .label { font-size: 10px; }
    .revealed-model .lab { font-size: 12px; }
    .result-next-btn { padding: 12px 28px; font-size: 14px; }

    /* FOOTER */
    .footer { flex-direction: column; gap: 16px; text-align: center; padding: 24px 16px; }
    .footer-left { font-size: 11px; }
    .footer-right { gap: 16px; }
    .footer-right a { font-size: 11px; }
  }

  /* Back button &mdash; matches trainingrun.ai style */
  .back-btn {
    position: fixed;
    top: 160px;
    left: 24px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: rgba(20, 20, 40, 0.7);
    border: 1px solid rgba(0, 212, 255, 0.15);
    border-radius: 8px;
    color: #a0a0b0;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    z-index: 100;
    transition: border-color 0.2s, color 0.2s;
    backdrop-filter: blur(8px);
  }
  .back-btn:hover {
    border-color: rgba(0, 212, 255, 0.4);
    color: #00d4ff;
  }
  footer {
    text-align: center;
    padding: 32px 40px;
    border-top: 1px solid var(--border);
    font-size: 13px;
    color: var(--text-dim);
  }

    .vote-both-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
    }
    .vote-btn-both {
      background: transparent;
      border: 1px solid var(--border-dim);
      color: var(--text-dim);
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    .vote-btn-both:hover:not(:disabled) {
      border-color: var(--accent-primary);
      color: var(--text-primary);
      background: rgba(0, 212, 255, 0.05);
    }
    .vote-btn-both.selected {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(0, 212, 255, 0.1);
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
    }
    .vote-btn-both:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  /* Phone Verification Modal (#6) */
  .phone-verify-overlay { display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(6,13,26,0.95);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:1000; }
  .phone-verify-modal { background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:40px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.4);text-align:center; }
  .phone-verify-modal h2 { font-family:"Space Grotesk",sans-serif;font-size:24px;font-weight:700;margin-bottom:8px; }
  .phone-verify-modal .subtitle { color:var(--text-secondary);font-size:14px;margin-bottom:28px;line-height:1.5; }
  .phone-verify-modal .shield-icon { font-size:48px;margin-bottom:16px; }
  .phone-input-group { display:flex;gap:8px;margin-bottom:16px; }
  .phone-input-group input { flex:1;padding:12px 16px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:"Inter",sans-serif;font-size:16px; }
  .phone-input-group input:focus { outline:none;border-color:var(--cyan); }
  .phone-verify-btn { width:100%;padding:14px 24px;background:var(--cyan);color:var(--bg-dark);border:none;border-radius:8px;font-family:"Space Grotesk",sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:opacity 0.2s; }
  .phone-verify-btn:hover { opacity:0.9; }
  .phone-verify-btn:disabled { opacity:0.5;cursor:not-allowed; }
  .phone-verify-error { color:var(--red);font-size:13px;margin-top:12px;min-height:20px; }
  .phone-verify-note { color:var(--text-dim);font-size:12px;margin-top:16px;line-height:1.4; }
  .otp-input { letter-spacing:8px;text-align:center;font-size:24px;font-family:"Space Grotesk",monospace; }
  .phone-step { display:none; }
  .phone-step.active { display:block; }
    }
  </style>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
</head>
<body>

<!-- TICKER 1: TRS SCORES -->
<div class="ticker-wrap">
  <div class="ticker-label trs">TRS SCORES</div>
  <div class="ticker-track">
    <div class="ticker-item"><span class="rank">#1</span> <span class="model">GPT-oss-120b</span> <span class="score">76.81</span></div>
    <div class="ticker-item"><span class="rank">#2</span> <span class="model">Claude Code</span> <span class="score">76.68</span> <span class="change-up">+0.38</span></div>
    <div class="ticker-item"><span class="rank">#3</span> <span class="model">GPT-5 mini</span> <span class="score">73.25</span> <span class="change-down">-0.04</span></div>
    <div class="ticker-item"><span class="rank">#4</span> <span class="model">GPT-4</span> <span class="score">71.14</span></div>
    <div class="ticker-item"><span class="rank">#5</span> <span class="model">Claude 3 Haiku</span> <span class="score">71.09</span></div>
    <div class="ticker-item"><span class="rank">#6</span> <span class="model">Palmyra X5</span> <span class="score">69.48</span></div>
    <div class="ticker-item"><span class="rank">#7</span> <span class="model">Qwen2 Instruct</span> <span class="score">68.45</span></div>
    <div class="ticker-item"><span class="rank">#8</span> <span class="model">Gemini 3 Pro</span> <span class="score">67.59</span></div>
    <!-- duplicate for seamless loop -->
    <div class="ticker-item"><span class="rank">#1</span> <span class="model">GPT-oss-120b</span> <span class="score">76.81</span></div>
    <div class="ticker-item"><span class="rank">#2</span> <span class="model">Claude Code</span> <span class="score">76.68</span> <span class="change-up">+0.38</span></div>
    <div class="ticker-item"><span class="rank">#3</span> <span class="model">GPT-5 mini</span> <span class="score">73.25</span> <span class="change-down">-0.04</span></div>
    <div class="ticker-item"><span class="rank">#4</span> <span class="model">GPT-4</span> <span class="score">71.14</span></div>
    <div class="ticker-item"><span class="rank">#5</span> <span class="model">Claude 3 Haiku</span> <span class="score">71.09</span></div>
    <div class="ticker-item"><span class="rank">#6</span> <span class="model">Palmyra X5</span> <span class="score">69.48</span></div>
    <div class="ticker-item"><span class="rank">#7</span> <span class="model">Qwen2 Instruct</span> <span class="score">68.45</span></div>
    <div class="ticker-item"><span class="rank">#8</span> <span class="model">Gemini 3 Pro</span> <span class="score">67.59</span></div>
  </div>
</div>

<!-- TICKER 2: ARENA LEADERS -->
<div <div class="ticker-wrap arena-ticker">
  <div class="ticker-label arena">ARENA LEADERBOARD</div>
  <div class="ticker-track">
    <div class="ticker-item"><span class="rank"><span style="font-size:18px;text-shadow:0 0 12px rgba(255,215,0,0.75),0 0 4px rgba(255,215,0,0.5)">&#x1F947;</span></span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank"><span style="font-size:18px;text-shadow:0 0 10px rgba(200,200,220,0.65),0 0 4px rgba(200,200,220,0.4)">&#x1F948;</span></span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank"><span style="font-size:18px;text-shadow:0 0 10px rgba(210,140,70,0.65),0 0 4px rgba(210,140,70,0.4)">&#x1F949;</span></span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#4</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#5</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#6</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#7</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#8</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#9</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#10</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">&#x1F947;</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">&#x1F948;</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">&#x1F949;</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#4</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#5</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#6</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#7</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#8</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#9</span> <span class="model">Coming Soon</span></div>
    <div class="ticker-item"><span class="rank">#10</span> <span class="model">Coming Soon</span></div>
  </div>
</div>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <!-- Shield Arena Logo -->
    <svg class="logo-mark" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Outer arena ring -->
      <circle cx="26" cy="26" r="24" stroke="#00e5ff" stroke-width="2" fill="none" opacity="0.3"/>
      <circle cx="26" cy="26" r="20" stroke="#00e5ff" stroke-width="1" fill="none" opacity="0.15"/>
      <!-- Small arena "seats" dots around ring -->
      <circle cx="26" cy="3" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="45" cy="14" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="49" cy="26" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="45" cy="38" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="26" cy="49" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="7" cy="38" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="3" cy="26" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <circle cx="7" cy="14" r="1.5" fill="#00e5ff" opacity="0.5"/>
      <!-- Shield in center -->
      <path d="M26 12 L36 18 L36 30 C36 36 26 42 26 42 C26 42 16 36 16 30 L16 18 Z"
            fill="rgba(0,229,255,0.1)" stroke="#00e5ff" stroke-width="2" stroke-linejoin="round"/>
      <!-- Checkmark inside shield -->
      <polyline points="21,27 24.5,31 31,22" stroke="#00e5ff" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div class="logo-text">
      <div class="brand">The <span>Safety</span> Arena</div>
      <div class="sub">Powered by <a href="https://trainingrun.ai">trainingrun.ai</a></div>
    </div>
  </div>
  <nav class="header-nav">
    <a href="index.html">Home</a>
    <a href="charter.html">Charter</a>
    <a href="#" class="btn-vote active" style="background: var(--orange); color: #fff;">&#9876; In the Arena</a>
  </nav>
  <div class="user-info" id="userInfo" style="display: none;">
    <div class="verified-badge">
      <span>&#x2713;</span>
      <span>Verified Voter</span>
    </div>
    <div class="user-email" id="userEmail"></div>
    <button class="logout-btn" onclick="handleLogout()">Logout</button>
  </div>
</header>
<a href="/" class="back-btn" onclick="history.back(); return false;">&larr; Back</a>


<!-- AUTH MODAL OVERLAY -->
<div class="auth-modal-overlay" id="authModal">
  <div class="auth-modal">
    <h2>Enter the Arena</h2>
    <p>Create an account or sign in to start voting on safety</p>

    <!-- Auth tabs -->
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <!-- Error message -->
    <div class="auth-error" id="authError"></div>

    <!-- Sign In Form -->
    <form class="auth-form active" id="signinForm" onsubmit="handleSignIn(event)">
      <div class="auth-form-group">
        <label for="signinEmail">Email</label>
        <input type="email" id="signinEmail" placeholder="you@example.com" required>
      </div>
      <div class="auth-form-group">
        <label for="signinPassword">Password</label>
        <input type="password" id="signinPassword" placeholder="Enter your password" required>
      </div>
      <button type="submit" class="auth-btn">Sign In</button>
    </form>

    <!-- Sign Up Form -->
    <form class="auth-form" id="signupForm" onsubmit="handleSignUp(event)">
      <div class="auth-form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" placeholder="you@example.com" required>
      </div>
      <div class="auth-form-group">
        <label for="signupPassword">Password</label>
        <input type="password" id="signupPassword" placeholder="Create a password" required>
      </div>
      <div class="auth-form-group">
        <label for="signupPasswordConfirm">Confirm Password</label>
        <input type="password" id="signupPasswordConfirm" placeholder="Confirm your password" required>
      </div>
            <div class="auth-form-group" style="margin-top: 12px;">
        <div id="turnstile-widget"></div>
      </div>
      <div class="auth-form-group tos-group">
        <label class="tos-label">
          <input type="checkbox" id="tosAgree" required>
          <span>I agree to the <a href="/terms.html" target="_blank">Terms of Service</a> and have read the <a href="/privacy.html" target="_blank">Privacy Policy</a></span>
        </label>
      </div>
      <button type="submit" class="auth-btn">Create Account</button>
    </form>

    <!-- Loading state -->
    <div class="auth-loading" id="authLoading">
      <p>Loading...</p>
    </div>

    <!-- Google Sign In (fallback) -->
    <button class="auth-btn google" id="googleSignInBtn" style="margin-top: 8px;" onclick="handleOAuthSignIn('google')">
      <span>G</span> Continue with Google
    </button>
    <button class="auth-btn twitter" id="twitterSignInBtn" style="margin-top: 8px;" onclick="handleOAuthSignIn('twitter')">
      <span>&#x1D54F;</span> Continue with X
    </button>
  </div>
</div>
<!-- PHONE VERIFICATION MODAL (#6) -->
<div class="phone-verify-overlay" id="phoneVerifyModal" style="display: none;">
  <div class="phone-verify-modal">
    <div class="shield-icon">&#x1F6E1;&#xFE0F;</div>
    <h2>Verify Your Phone</h2>
    <p class="subtitle">One last step before voting. We verify every voter's phone number to ensure one real human, one real vote.</p>
    <div class="phone-step active" id="phoneStep1">
      <div class="phone-input-group">
        <input type="tel" id="phoneNumber" placeholder="+1 (555) 123-4567" autocomplete="tel">
      </div>
      <button class="phone-verify-btn" id="sendOtpBtn" onclick="sendPhoneOtp()">Send Verification Code</button>
    </div>
    <div class="phone-step" id="phoneStep2">
      <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px;">Enter the 6-digit code sent to <span id="phoneDisplay"></span></p>
      <div class="phone-input-group">
        <input type="text" id="otpCode" class="otp-input" maxlength="6" placeholder="000000" autocomplete="one-time-code">
      </div>
      <button class="phone-verify-btn" id="verifyOtpBtn" onclick="verifyPhoneOtp()">Verify & Enter Arena</button>
      <p style="margin-top:12px;"><a href="#" onclick="resendOtp();return false;" style="color:var(--cyan);font-size:13px;">Resend code</a> &middot; <a href="#" onclick="changePhone();return false;" style="color:var(--text-dim);font-size:13px;">Change number</a></p>
    </div>
    <div class="phone-verify-error" id="phoneVerifyError"></div>
    <p class="phone-verify-note">Your number is used only for verification and is never shared. This is how we keep every vote real.</p>
    <div style="margin-top:20px;text-align:center;">
      <a href="#" onclick="skipPhoneVerify();return false;" style="color:#00e5ff;font-size:16px;font-weight:600;text-decoration:underline;text-underline-offset:4px;">Skip for now &mdash; SMS verification coming soon</a>
    </div>
  </div>
</div>


<!-- ARENA CONTENT -->
<main class="arena-container" style="display: none;" id="arenaContent">

  <!-- Battle header -->
  <div class="battle-header">
    <div class="battle-count"><span class="live-dot"></span> Battle <span id="battleId">---</span> &mdash; <span id="totalVotes">0</span> total votes cast</div>
    <h1>Which response is safer?</h1>
    <p>Read both responses below, then pick the one you think handled it better.</p>
  </div>

  <!-- Engagement timer (appears while user reads) -->
  <div class="engagement-timer" id="engagementTimer" style="display: none;">
    <span>Read for <span class="timer-countdown" id="timerCountdown">30s</span> more...</span>
  </div>

  <!-- Scenario prompt -->
  <div class="scenario">
    <div class="scenario-label"><span id="scenarioCategory" style="display:none"></span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Scenario
    </div>
    <p class="scenario-text" id="scenarioText">Loading scenario...</p>
  </div>

  <div class="battle-container">
    <div class="response-card" id="responseA">
      <div class="response-header">
        <span class="model-label">Response A</span>
      </div>
      <div class="response-text" id="responseTextA">Loading...</div>
    </div>
    <div class="vs-divider">
      <div class="vs-badge">VS</div>
    </div>
    <div class="response-card" id="responseB">
      <div class="response-header">
        <span class="model-label">Response B</span>
      </div>
      <div class="response-text" id="responseTextB">Loading...</div>
    </div>
  </div>

  <div class="vote-section">
    <div class="vote-buttons">
      <div class="vote-col">
        <button class="vote-btn vote-btn-a" id="voteA" onclick="selectVote('A')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          Vote for A
        </button>
      </div>
      <div class="vote-col-tie">
        <button class="vote-btn vote-btn-tie" id="voteTie" onclick="selectVote('tie')">Tie</button>
      </div>
      <div class="vote-col">
        <button class="vote-btn vote-btn-b" id="voteB" onclick="selectVote('B')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          Vote for B
        </button>
      </div>
    </div>
    
    <div class="vote-both-row">
      <button class="vote-btn-both" id="voteBOTH_GOOD" onclick="selectVote('both_good')" disabled>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: -2px;"><path d="M14 9V5a3 3 0 0 0-6 0v4"/><path d="M18 8h-6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-3a7 7 0 0 0-4-6.3z"/></svg>
        Both are good
      </button>
      <button class="vote-btn-both" id="voteBOTH_BAD" onclick="selectVote('both_bad')" disabled>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: -2px;"><path d="M10 15v4a3 3 0 0 0 6 0v-4"/><path d="M6 16h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v3a7 7 0 0 0 4 6.3z"/></svg>
        Both are bad
      </button>
    </div>
    <div class="vote-explanation" id="voteExplanation">
      <label class="explanation-label">Why did you choose this response? (optional)</label>
      <textarea id="explanationText" class="explanation-input" placeholder="Share your reasoning to help improve AI safety research..."></textarea>
          <div style="font-size:12px;color:#888"><span id="wordCount">0</span> words <span id="wordStatus"></span></div>
          <button id="submitVoteBtn" class="submit-vote-btn" onclick="submitVote()">Submit Vote</button>
          <input type="text" id="honeypot-website" style="display:none" tabindex="-1">
    </div>
  </div>

  <div class="result-reveal" id="resultReveal">
    <!-- Dynamically populated by showResultReveal() -->
  </div>

  <div class="progress-section">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
    <span id="votesRemaining" style="display:none"></span><p class="progress-text" id="progressText">0 of 30 battles completed</p>
  <div style="text-align:center;padding:24px 0 8px;">
    <button onclick="loadNextBattle()" style="background:#00d4ff;color:#0a0a0f;border:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:.5px;">Next Battle &rarr;</button>
    <a href="index.html" style="display:inline-block;margin-left:12px;padding:14px 28px;border:1px solid #444;border-radius:8px;color:#888;font-size:14px;text-decoration:none;">&larr; Home</a>
  </div>
  </div>
</main>

<footer class="arena-footer">
  <p class="footer-copy">&copy; 2026 The Safety Arena &mdash; Independent AI Safety Research</p>
  <p class="footer-links" style="margin-top:8px;font-size:12px;color:#546e7a;"><a href="/privacy.html" style="color:#546e7a;text-decoration:none;margin-right:16px;">Privacy Policy</a><a href="/terms.html" style="color:#546e7a;text-decoration:none;">Terms of Service</a></p>
</footer>
<script>
  const SUPABASE_URL = 'https://nvitztmlczdohicskrks.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52aXR6dG1sY3pkb2hpY3NrcmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzY3NDQsImV4cCI6MjA4NzcxMjc0NH0.g8SgL67sDyDvDQko8QFhTPj5Bkt88MdtIcgHpOy2f48';
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Company logo mapping (GitHub avatar URLs)
  // Model-to-company mapping loaded from models.json (single source of truth)
      let COMPANY_LOGOS = {};
      let COMPANY_COLORS = {};
      let MODEL_TO_COMPANY = {};
      
      (async function loadModelMapping() {
        try {
          const resp = await fetch('models.json?v=' + Date.now());
          const data = await resp.json();
          for (const [company, info] of Object.entries(data.companies)) {
            COMPANY_LOGOS[company] = info.logo;
            COMPANY_COLORS[company] = info.color;
          }
          MODEL_TO_COMPANY = data.models;
          console.log('Loaded model mapping:', Object.keys(MODEL_TO_COMPANY).length, 'models,', Object.keys(COMPANY_LOGOS).length, 'companies');
        } catch (e) {
          console.error('Failed to load models.json:', e);
        }
      })();

  const fpPromise = FingerprintJS.load();

  let currentUser = null;
  let currentBattle = null;
  let selectedVote = null;
  let visitorFingerprint = null;
  let battlesCompleted = 0;

  class EngagementTracker {
    constructor() {
      this.timerInterval = null;
      this.timerStarted = false;
      this.mouseMovements = 0;
      this.maxScrollDepth = 0;
      this.battleStartTime = Date.now();
    }

    start() {
      this.battleStartTime = Date.now();
      document.addEventListener('mousemove', () => { this.mouseMovements++; });
      window.addEventListener('scroll', () => {
        const depth = (window.scrollY + window.innerHeight) / document.documentElement.scrollHeight;
        if (depth > this.maxScrollDepth) this.maxScrollDepth = depth;
      });
    }

    startReadTimer() {
      const timerEl = document.getElementById('engagementTimer');
      if (!timerEl || this.timerStarted) return;
      this.timerStarted = true;
      timerEl.style.display = '';
      let secondsRemaining = 30;
      const countdown = document.getElementById('timerCountdown');
      this.timerInterval = setInterval(() => {
        secondsRemaining--;
        if (countdown) countdown.textContent = secondsRemaining + 's';

        if (secondsRemaining <= 0) {
          clearInterval(this.timerInterval);
          if (timerEl) timerEl.style.display = 'none';
          enableVoteButtons();
        }
      }, 1000);
    }

    getMetrics() {
      const timeOnPageMs = Date.now() - this.battleStartTime;
      return {
        time_on_page: Math.floor(timeOnPageMs / 1000),
        mouse_movements: this.mouseMovements,
        scroll_depth: Math.round(this.maxScrollDepth * 100)
      };
    }

    reset() {
      if (this.timerInterval) clearInterval(this.timerInterval);
      this.timerStarted = false;
      this.mouseMovements = 0;
      this.maxScrollDepth = 0;
    }
  }

  const engagementTracker = new EngagementTracker();

  // ============================================================
  // AUTH FUNCTIONS
  // ============================================================
  function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));

    document.querySelector(`[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
    document.getElementById(tab === 'signin' ? 'signinForm' : 'signupForm').classList.add('active');

    clearAuthError();
  }

  function showAuthError(message) {
    const errorEl = document.getElementById('authError');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  function clearAuthError() {
    const errorEl = document.getElementById('authError');
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }

    let turnstileToken = null;
  let turnstileWidgetId = null;

  function renderTurnstile() {
    if (typeof turnstile !== 'undefined' && document.getElementById('turnstile-widget')) {
      turnstileWidgetId = turnstile.render('#turnstile-widget', {
        sitekey: '0x4AAAAAACj1-HA26A5F1VNh',
        theme: 'dark',
        callback: function(token) { turnstileToken = token; },
        'expired-callback': function() { turnstileToken = null; }
      });
    }
  }

async function handleOAuthSignIn(provider) {
    try {
      const { data, error } = supabaseClient.auth.signInWithOAuth({
        provider: provider,
        options: {
          redirectTo: window.location.origin + '/vote.html'
        }
      });
      if (error) {
        showAuthError(error.message);
      }
    } catch (err) {
      showAuthError('OAuth sign-in failed. Please try again.');
    }
  }

  function handleSignIn(event) {
    event.preventDefault();
    const email = document.getElementById('signinEmail').value;
    const password = document.getElementById('signinPassword').value;

    showLoadingState();

    supabase.auth.signInWithPassword({ email, password })
      .then(({ data, error }) => {
        hideLoadingState();
        if (error) {
          showAuthError(error.message);
        } else {
          currentUser = data.user;
          initializeArena();
        }
      });
  }

  function handleSignUp(event) {
    event.preventDefault();
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

    if (password !== passwordConfirm) {
      showAuthError('Passwords do not match');
      return;
    }

    const tosChecked = document.getElementById('tosAgree').checked;
    if (!tosChecked) {
      showAuthError('You must agree to the Terms of Service to create an account');
      return;
    }

    if (!turnstileToken) {
      showAuthError('Please complete the CAPTCHA verification.');
      return;
    }

    showLoadingState();

    supabase.auth.signUp({ email, password })
      .then(({ data, error }) => {
        hideLoadingState();
        if (error) {
          showAuthError(error.message);
        } else {
          currentUser = data.user;
          initializeArena();
        }
      });
  }

  function handleLogout() {
    supabase.auth.signOut().then(() => {
      currentUser = null;
      location.reload();
    });
  }

  function showLoadingState() {
    document.getElementById('authLoading').style.display = 'block';
    document.getElementById('signinForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'none';
  }

  function hideLoadingState() {
    document.getElementById('authLoading').style.display = 'none';
    const activeTab = document.querySelector('.auth-tab.active');
    if (activeTab.textContent.includes('Sign In')) {
      document.getElementById('signinForm').style.display = 'block';
    } else {
      document.getElementById('signupForm').style.display = 'block';
    }
  }

  // ============================================================
  // INITIALIZATION & ARENA SETUP
    // ============================================================
    // PHONE VERIFICATION (#6)
    // ============================================================
    let pendingPhoneNumber = null;

    function formatPhoneNumber(input) {
      let val = input.replace(/[^\d+]/g, '');
      if (!val.startsWith('+')) {
        if (val.length === 10) val = '+1' + val;
        else if (val.length === 11 && val.startsWith('1')) val = '+' + val;
      }
      return val;
    }

    async function sendPhoneOtp() {
      var phoneInput = document.getElementById('phoneNumber').value.trim();
      var errorEl = document.getElementById('phoneVerifyError');
      var btn = document.getElementById('sendOtpBtn');
      errorEl.textContent = '';
      var phone = formatPhoneNumber(phoneInput);
      if (phone.length < 10) { errorEl.textContent = 'Please enter a valid phone number with country code (e.g. +15551234567)'; return; }
      btn.disabled = true; btn.textContent = 'Sending...';
      pendingPhoneNumber = phone;
      try {
        var result = await supabase.auth.updateUser({ phone: phone });
        if (result.error) throw result.error;
        document.getElementById('phoneStep1').classList.remove('active');
        document.getElementById('phoneStep2').classList.add('active');
        document.getElementById('phoneDisplay').textContent = phone;
        document.getElementById('otpCode').focus();
      } catch (err) {
        errorEl.textContent = err.message || 'Failed to send code. Please try again.';
      } finally { btn.disabled = false; btn.textContent = 'Send Verification Code'; }
    }

    async function verifyPhoneOtp() {
      var code = document.getElementById('otpCode').value.trim();
      var errorEl = document.getElementById('phoneVerifyError');
      var btn = document.getElementById('verifyOtpBtn');
      errorEl.textContent = '';
      if (code.length !== 6) { errorEl.textContent = 'Please enter the 6-digit code.'; return; }
      btn.disabled = true; btn.textContent = 'Verifying...';
      try {
        var result = await supabase.auth.verifyOtp({ phone: pendingPhoneNumber, token: code, type: 'phone_change' });
        if (result.error) throw result.error;
        var userData = await supabase.auth.getUser();
        currentUser = userData.data.user;
        document.getElementById('phoneVerifyModal').style.display = 'none';
        showArena();
      } catch (err) {
        errorEl.textContent = err.message || 'Invalid code. Please try again.';
      } finally { btn.disabled = false; btn.textContent = 'Verify & Enter Arena'; }
    }

    async function resendOtp() {
      if (!pendingPhoneNumber) return;
      var errorEl = document.getElementById('phoneVerifyError');
      errorEl.textContent = '';
      try {
        await supabase.auth.updateUser({ phone: pendingPhoneNumber });
        errorEl.style.color = 'var(--green)'; errorEl.textContent = 'New code sent!';
        setTimeout(function() { errorEl.style.color = 'var(--red)'; errorEl.textContent = ''; }, 3000);
      } catch (err) { errorEl.textContent = 'Failed to resend.'; }
    }

    function changePhone() {
      document.getElementById('phoneStep2').classList.remove('active');
      document.getElementById('phoneStep1').classList.add('active');
      document.getElementById('phoneVerifyError').textContent = '';
      pendingPhoneNumber = null;
    }

    function isPhoneVerified(user) {
      return !!(user && user.phone && user.phone_confirmed_at);
    }

    async function skipPhoneVerify() {
      document.querySelector(".phone-verify-overlay").style.display = "none";
      showArena();
    }

    async function showArena() {
      document.getElementById('arenaContent').style.display = 'block';
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userEmail').textContent = currentUser ? currentUser.email : '';
      var badge = document.querySelector('.verified-badge span:last-child');
      if (badge && isPhoneVerified(currentUser)) badge.textContent = 'Verified Voter &bull; Phone';
      var fp = await fpPromise;
      var result = await fp.get();
      visitorFingerprint = result.visitorId;
      engagementTracker.start();
      await loadNextBattle();
      await loadRateLimitInfo();
    }

    async function initializeArena() {
      // Hide auth modal
      document.getElementById('authModal').style.display = 'none';

      // Check phone verification (#6)
      if (!isPhoneVerified(currentUser)) {
        document.getElementById('phoneVerifyModal').style.display = 'flex';
        return;
      }

      // Phone is verified - proceed to arena
      await showArena();
    }

  // ============================================================
  // BATTLE LOADING & RENDERING
  // ============================================================
  async function loadNextBattle() {
    engagementTracker.reset();
    selectedVote = null;

    // Reset UI
    disableVoteButtons();
    document.getElementById('voteExplanation').classList.remove('show');
    document.getElementById('explanationText').value = '';
    document.getElementById('resultReveal').classList.remove('show');
    document.getElementById('responseA').classList.remove('selected');
    document.getElementById('responseB').classList.remove('selected');
    document.getElementById('voteA').classList.remove('selected');
    document.getElementById('voteB').classList.remove('selected');

    // Reset submit button for new battle
    const submitBtn = document.getElementById('submitVoteBtn');
    submitBtn.classList.remove('submitting', 'submitted');
    submitBtn.textContent = 'Submit Vote';
    submitBtn.style.display = '';

    // Remove auto-next countdown if present
    const countdown = document.getElementById('autoNextCountdown');
    if (countdown) countdown.remove();

    try {
      // Direct DB query for battles (#19 - removed non-existent edge function)
      let battle = await getNextBattleFromDB();

      if (!battle) {
        console.error('No battles available');
        return;
      }

      currentBattle = battle;

      // Randomly swap A/B to maintain blindness
      if (Math.random() > 0.5) {
        [currentBattle.model_a, currentBattle.model_b] = [currentBattle.model_b, currentBattle.model_a];
        [currentBattle.response_a, currentBattle.response_b] = [currentBattle.response_b, currentBattle.response_a];
        currentBattle.swapped = true;
      } else {
        currentBattle.swapped = false;
      }

      renderBattle(battle);
      engagementTracker.startReadTimer();

      // Update progress
      battlesCompleted++;
      updateProgressBar();

      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      console.error('Error loading battle:', error);
    }
  }

async function getNextBattleFromDB() {
    try {
      // Get random offset for variety
      const offsetResponse = await supabase
        .from('battles')
        .select('id', { count: 'exact', head: true });

      const totalBattles = offsetResponse.count || 1;
      const randomOffset = Math.floor(Math.random() * Math.max(1, totalBattles - 1));

      const { data, error } = await supabase
        .from('battles')
        .select('*, prompt:prompts(text, category), model_a:models!battles_model_a_id_fkey(id, name, lab), model_b:models!battles_model_b_id_fkey(id, name, lab)')
        .eq('is_public', true)
        .range(randomOffset, randomOffset)
        .single();

      if (error) throw error;

      // Transform data to match expected structure
      return {
        id: data.id,
        prompt_text: data.prompt?.text || '',
        prompt_category: data.prompt?.category || '',
        response_a: data.model_a_response || '',
        response_b: data.model_b_response || '',
        model_a: data.model_a,
        model_b: data.model_b,
        votes_a: data.votes_a || 0,
        votes_b: data.votes_b || 0,
        votes_tie: data.votes_tie || 0
      };
    } catch (error) {
      console.error('Error fetching battle:', error);
      return null;
    }
  }

  
    // ============================================================
    // COUNTER DE-ANONYMIZATION (#14) - Formatting Noise
    // ============================================================
    
    // Normalize response text to reduce model fingerprinting
    function normalizeResponse(text) {
      if (!text) return '';
      let t = text;
      // Normalize em-dashes and en-dashes to hyphens
      t = t.replace(/[\u2013\u2014]/g, '-');
      // Normalize fancy quotes to straight quotes
      t = t.replace(/[\u201C\u201D]/g, '"');
      t = t.replace(/[\u2018\u2019]/g, "'");
      // Normalize ellipsis character to three dots
      t = t.replace(/\u2026/g, '...');
      // Normalize bullet characters to standard dash
      t = t.replace(/[\u2022\u2023\u25E6\u2043\u2219]/g, '-');
      // Strip leading numbering patterns (1. 2. 3.) that differ between models
      t = t.replace(/^(\d+[\.\)\:]\s)/gm, '- ');
      // Normalize multiple newlines to max 2
      t = t.replace(/\n{3,}/g, '\n\n');
      // Trim trailing whitespace per line
      t = t.replace(/[ \t]+$/gm, '');
      return t;
    }
    
    // Add noise to vote counters to prevent correlation
    function addCounterNoise(count) {
      if (count <= 0) return 0;
      // Add random noise of +/- up to 2, floor at 1
      const noise = Math.floor(Math.random() * 5) - 2;
      return Math.max(1, count + noise);
    }

  // Edge function removed (#19) - using direct DB query

  
    // ============================================================
    // COUNTER DE-ANONYMIZATION (#14) - Formatting Noise
    // ============================================================
    
    // Normalize response text to reduce model fingerprinting
    function normalizeResponse(text) {
      if (!text) return '';
      let t = text;
      // Normalize em-dashes and en-dashes to hyphens
      t = t.replace(/[\u2013\u2014]/g, '-');
      // Normalize fancy quotes to straight quotes
      t = t.replace(/[\u201C\u201D]/g, '"');
      t = t.replace(/[\u2018\u2019]/g, "'");
      // Normalize ellipsis character to three dots
      t = t.replace(/\u2026/g, '...');
      // Normalize bullet characters to standard dash
      t = t.replace(/[\u2022\u2023\u25E6\u2043\u2219]/g, '-');
      // Strip leading numbering patterns (1. 2. 3.) that differ between models
      t = t.replace(/^(\d+[\.\)\:]\s)/gm, '- ');
      // Normalize multiple newlines to max 2
      t = t.replace(/\n{3,}/g, '\n\n');
      // Trim trailing whitespace per line
      t = t.replace(/[ \t]+$/gm, '');
      return t;
    }
    
    // Add noise to vote counters to prevent correlation
    function addCounterNoise(count) {
      if (count <= 0) return 0;
      // Add random noise of +/- up to 2, floor at 1
      const noise = Math.floor(Math.random() * 5) - 2;
      return Math.max(1, count + noise);
    }

    function renderBattle(battle) {
    document.getElementById('battleId').textContent = battle.id.substring(0, 8).toUpperCase();
    document.getElementById('scenarioText').textContent = battle.prompt_text;
    document.getElementById('scenarioCategory').textContent = battle.prompt_category;
    document.getElementById('responseTextA').innerHTML = `<p>${normalizeResponse(battle.response_a)}</p>`;
    document.getElementById('responseTextB').innerHTML = `<p>${normalizeResponse(battle.response_b)}</p>`;

    const totalVotes = (battle.votes_a || 0) + (battle.votes_b || 0) + (battle.votes_tie || 0);
    document.getElementById('totalVotes').textContent = addCounterNoise(totalVotes);
  }

  // ============================================================
  // VOTING FUNCTIONS
  // ============================================================
  function selectVote(choice) {
    // Remove previous selection
    if (selectedVote) {
      const prevVoteEl = document.getElementById(`vote${selectedVote.toUpperCase()}`);
      if (prevVoteEl) prevVoteEl.classList.remove('selected');
      const prevRespEl = document.getElementById(`response${selectedVote.toUpperCase()}`);
      if (prevRespEl) prevRespEl.classList.remove('selected');
    }

    selectedVote = choice;

    // Add new selection
    const newVoteEl = document.getElementById(`vote${choice.toUpperCase()}`);
    if (newVoteEl) newVoteEl.classList.add('selected');
    const newRespEl = document.getElementById(`response${choice.toUpperCase()}`);
    if (newRespEl) newRespEl.classList.add('selected');

    // Show explanation section and enable submit
    document.getElementById('voteExplanation').style.display = 'block';
    updateWordCount();
  }

  function updateWordCount() {
    const text = document.getElementById('explanationText').value;
    const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;

    document.getElementById('wordCount').textContent = words;

    const wordCountEl = document.getElementById('wordCount');
    const statusEl = document.getElementById('wordStatus');
    const submitBtn = document.getElementById('submitVoteBtn');

    if (words === 0) {
      wordCountEl.classList.remove('invalid', 'valid');
      statusEl.textContent = '';
      statusEl.style.color = '';
      submitBtn.disabled = false;
    } else if (words >= 10 && words <= 50) {
      wordCountEl.classList.remove('invalid');
      wordCountEl.classList.add('valid');
      statusEl.textContent = ' Ready';
      statusEl.style.color = 'var(--green)';
      submitBtn.disabled = false;
    } else {
      wordCountEl.classList.remove('valid');
      wordCountEl.classList.add('invalid');
      statusEl.textContent = words < 10 ? 'Too short' : 'Too long';
      statusEl.style.color = 'var(--red)';
      submitBtn.disabled = true;
    }
  }

  async function submitVote() {
    if (!selectedVote || !currentBattle) return;

    // Visual feedback: show submitting state
    const submitBtn = document.getElementById('submitVoteBtn');
    submitBtn.classList.add('submitting');
    submitBtn.textContent = 'Submitting...';

    // Account age threshold check (#7)
    try {
      const { data: { user: ageCheckUser } } = await supabase.auth.getUser();
      if (ageCheckUser && ageCheckUser.created_at) {
        const accountCreated = new Date(ageCheckUser.created_at);
        const daysSinceCreation = (Date.now() - accountCreated.getTime()) / (1000 * 60 * 60 * 24);
        const MIN_ACCOUNT_AGE_DAYS = 0; // Set to 1-30 to enforce; 0 = disabled for launch
        if (MIN_ACCOUNT_AGE_DAYS > 0 && daysSinceCreation < MIN_ACCOUNT_AGE_DAYS) {
          const daysLeft = Math.ceil(MIN_ACCOUNT_AGE_DAYS - daysSinceCreation);
          document.getElementById('explanationText').placeholder = 'Your account must be at least ' + MIN_ACCOUNT_AGE_DAYS + ' day(s) old to vote. Please wait ' + daysLeft + ' more day(s).';
          return;
        }
      }
    } catch(ageErr) { /* If age check fails, allow vote */ }


    const explanation = document.getElementById('explanationText').value;
    const honeypotValue = document.getElementById('honeypot-website').value;

    // ANTI-GAMING: Honeypot check
    // If honeypot field has value, bot tried to fill it. Silently fail.
    if (honeypotValue && honeypotValue.trim().length > 0) {
      console.warn('Honeypot triggered - likely bot submission');
      showResultReveal();
      return;
    }

    const metrics = engagementTracker.getMetrics();

    const votePayload = {
      battle_id: currentBattle.id,
      user_id: currentUser?.id,
      vote_choice: selectedVote.toUpperCase(),
      vote_explanation: explanation,
      time_on_page: metrics.time_on_page,
      mouse_movements: metrics.mouse_movements,
      scroll_depth: metrics.scroll_depth,
      device_fingerprint: visitorFingerprint,
        ip_address: userIpAddress
    };

    // ANTI-GAMING: Turnstile CAPTCHA verification
    const turnstileToken = typeof turnstile !== 'undefined' ? turnstile.getResponse() : null;
    if (!turnstileToken) {
      console.warn('Turnstile token missing - possible bot');
      const voteError = document.getElementById('voteError');
      if (voteError) {
        voteError.textContent = 'Verification failed. Please wait a moment and try again.';
        voteError.style.display = 'block';
      }
      submitBtn.classList.remove('submitting');
      submitBtn.textContent = 'Submit Vote';
      enableVoteButtons();
      return;
    }

    // Server-side vote submission via Edge Function
    const edgeFunctionUrl = 'https://nvitztmlczdohicskrks.supabase.co/functions/v1/submit-vote';
    const session = (await supabase.auth.getSession()).data.session;
    
    const edgeResponse = await fetch(edgeFunctionUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + session.access_token,
        'apikey': SUPABASE_ANON_KEY,
      },
      body: JSON.stringify({
        battle_id: votePayload.battle_id,
        vote_choice: votePayload.vote_choice,
        vote_explanation: votePayload.vote_explanation,
        time_on_page: votePayload.time_on_page,
        mouse_movements: votePayload.mouse_movements,
        scroll_depth: votePayload.scroll_depth,
        device_fingerprint: votePayload.device_fingerprint,
        turnstile_token: turnstileToken,
        honeypot: document.getElementById('website')?.value || '',
      }),
    });

    const edgeResult = await edgeResponse.json();

    if (!edgeResponse.ok) {
      console.error('Vote submission error:', edgeResult.error);
      const voteError = document.getElementById('voteError');
      if (voteError) {
        voteError.textContent = edgeResult.error || 'Vote submission failed. Please try again.';
        voteError.style.display = 'block';
      }
      submitBtn.classList.remove('submitting');
      submitBtn.textContent = 'Submit Vote';
      enableVoteButtons();
      return;
    }

    // Reset Turnstile for next vote
    if (typeof turnstile !== 'undefined') {
      try { turnstile.reset(); } catch(e) { console.warn('Turnstile reset failed:', e); }
    }

    // Visual feedback: show success state
    submitBtn.classList.remove('submitting');
    submitBtn.classList.add('submitted');
    submitBtn.textContent = '\u2713 Vote Submitted!';

    // Show result reveal
    showResultReveal();
  }

  function showResultReveal() {
    const aName = currentBattle.model_a?.name || 'Unknown';
    const aLab = currentBattle.model_a?.lab || MODEL_TO_COMPANY[aName] || '';
    const bName = currentBattle.model_b?.name || 'Unknown';
    const bLab = currentBattle.model_b?.lab || MODEL_TO_COMPANY[bName] || '';

    const totalVotes = (currentBattle.votes_a || 0) + (currentBattle.votes_b || 0) + (currentBattle.votes_tie || 0);
    const pctA = totalVotes > 0 ? Math.round((currentBattle.votes_a / totalVotes) * 100) : 0;
    const pctB = totalVotes > 0 ? Math.round((currentBattle.votes_b / totalVotes) * 100) : 0;
    const pctTie = totalVotes > 0 ? Math.round((currentBattle.votes_tie / totalVotes) * 100) : 0;

    const logoUrl = (lab) => COMPANY_LOGOS[lab] || '';
    const brandColor = (lab) => COMPANY_COLORS[lab] || '#546e7a';

    let winName, winLab, winTag, loseName, loseLab, loseTag, isTie = false, pickB = false;

    if (selectedVote === 'A') {
      winName = aName; winLab = aLab; winTag = 'Response A';
      loseName = bName; loseLab = bLab; loseTag = 'Response B';
    } else if (selectedVote === 'B') {
      winName = bName; winLab = bLab; winTag = 'Response B';
      loseName = aName; loseLab = aLab; loseTag = 'Response A';
      pickB = true;
    } else {
      isTie = true;
    }

    const reveal = document.getElementById('resultReveal');

    if (isTie) {
      reveal.innerHTML = `
        <div style="text-align:center;margin-bottom:20px">
          <h2 style="font-family:'Space Grotesk',sans-serif;font-size:26px;color:#fff;margin-bottom:4px">The Models Were...</h2>
          <p style="font-size:14px;color:var(--cyan);font-weight:600">You voted Tie</p>
        </div>
        <div class="reveal-tie">
          <div class="reveal-logo" style="background:#0c1829;border:2px solid ${brandColor(aLab)}">
            ${logoUrl(aLab) ? '<img src="'+logoUrl(aLab)+'" alt="'+aLab+'">' : ''}
          </div>
          <div><div class="reveal-response-tag">Response A</div>
            <div class="reveal-model-name">${aName}</div>
            <div class="reveal-company">${aLab}</div></div>
        </div>
        <div class="reveal-tie-divider"><span>TIE</span></div>
        <div class="reveal-tie">
          <div class="reveal-logo" style="background:#0c1829;border:2px solid ${brandColor(bLab)}">
            ${logoUrl(bLab) ? '<img src="'+logoUrl(bLab)+'" alt="'+bLab+'">' : ''}
          </div>
          <div><div class="reveal-response-tag">Response B</div>
            <div class="reveal-model-name">${bName}</div>
            <div class="reveal-company">${bLab}</div></div>
        </div>
        <div class="reveal-community">
          <div class="reveal-community-label">Community Votes</div>
          <div class="reveal-bar-track">
            <div class="reveal-bar-a" style="width:${pctA}%"></div>
            <div class="reveal-bar-tie" style="width:${pctTie}%"></div>
            <div class="reveal-bar-b" style="width:${pctB}%"></div>
          </div>
          <div class="reveal-bar-labels">
            <span class="rbl-a">A: ${pctA}%</span>
            <span class="rbl-t">Tie: ${pctTie}%</span>
            <span class="rbl-b">B: ${pctB}%</span>
          </div>
        </div>`;
    } else {
      reveal.innerHTML = `
        <div style="text-align:center;margin-bottom:20px">
          <h2 style="font-family:'Space Grotesk',sans-serif;font-size:26px;color:#fff;margin-bottom:4px">The Models Were...</h2>
          <p style="font-size:14px;color:var(--cyan);font-weight:600">You voted for ${winTag}</p>
        </div>
        <div class="reveal-winner ${pickB ? 'pick-b' : ''}">
          <div class="reveal-badge">YOUR PICK</div>
          <div class="reveal-top">
            <div class="reveal-logo" style="background:#0c1829;border:2px solid ${brandColor(winLab)}">
              ${logoUrl(winLab) ? '<img src="'+logoUrl(winLab)+'" alt="'+winLab+'">' : ''}
            </div>
            <div>
              <div class="reveal-response-tag">${winTag}</div>
              <div class="reveal-model-name">${winName}</div>
              <div class="reveal-company">${winLab}</div>
            </div>
          </div>
          <div class="reveal-stats">
            <div><div class="reveal-stat-val">${currentBattle.model_a?.elo_rating || '--'}</div><div class="reveal-stat-lbl">Elo Rating</div></div>
            <div><div class="reveal-stat-val">${currentBattle.model_a?.total_battles || '--'}</div><div class="reveal-stat-lbl">Total Battles</div></div>
          </div>
        </div>
        <div class="reveal-loser">
          <div class="reveal-logo" style="background:#0c1829;border:2px solid ${brandColor(loseLab)}">
            ${logoUrl(loseLab) ? '<img src="'+logoUrl(loseLab)+'" alt="'+loseLab+'">' : ''}
          </div>
          <div>
            <div class="reveal-response-tag">${loseTag}</div>
            <div class="reveal-model-name">${loseName}</div>
            <div class="reveal-company">${loseLab}</div>
          </div>
          <div class="reveal-loser-tag">Runner Up</div>
        </div>
        <div class="reveal-community">
          <div class="reveal-community-label">Community Votes</div>
          <div class="reveal-bar-track">
            <div class="reveal-bar-a" style="width:${pctA}%"></div>
            <div class="reveal-bar-tie" style="width:${pctTie}%"></div>
            <div class="reveal-bar-b" style="width:${pctB}%"></div>
          </div>
          <div class="reveal-bar-labels">
            <span class="rbl-a">A: ${pctA}%</span>
            <span class="rbl-t">Tie: ${pctTie}%</span>
            <span class="rbl-b">B: ${pctB}%</span>
          </div>
        </div>`;
    }

    reveal.classList.add('show');
    setTimeout(() => { reveal.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200);

    // Decrement votes remaining
    votesRemainingToday--;
    updateVotesRemainingDisplay();
    document.getElementById('submitVoteBtn').style.display = 'none';
    document.getElementById('voteExplanation').style.display = 'none';

    // Auto-load next battle after 4 seconds
    if (votesRemainingToday > 0) {
      const countdownEl = document.createElement('p');
      countdownEl.id = 'autoNextCountdown';
      countdownEl.style.cssText = 'text-align:center;color:#00d4ff;font-size:14px;margin-top:12px;';
      let secs = 4;
      countdownEl.textContent = 'Next battle in ' + secs + 's...';
      reveal.appendChild(countdownEl);
      const cdInterval = setInterval(() => {
        secs--;
        if (secs > 0) {
          countdownEl.textContent = 'Next battle in ' + secs + 's...';
        } else {
          clearInterval(cdInterval);
          loadNextBattle();
        }
      }, 1000);
      countdownEl.style.cursor = 'pointer';
      countdownEl.addEventListener('click', () => { clearInterval(cdInterval); loadNextBattle(); });
    }
  }


  // ============================================================
  // RATE LIMITING
  // ============================================================
  async function loadRateLimitInfo() {
    try {
      const { data, error } = await supabase
        .from('rate_limits')
        .select('votes_today, current_limit')
        .eq('user_id', currentUser?.id)
        .single();

      if (data) {
        votesRemainingToday = Math.max(0, (data.current_limit || 10) - (data.votes_today || 0));
      } else {
        // First time user, create rate limit entry with default 10 votes/day
        votesRemainingToday = 10;
        await supabase.from('rate_limits').insert([{
          user_id: currentUser?.id,
          votes_today: 0,
          current_limit: 10
        }]);
      }

      updateVotesRemainingDisplay();
    } catch (error) {
      console.error('Error loading rate limit:', error);
      votesRemainingToday = 100;
      updateVotesRemainingDisplay();
    }
  }

  function updateVotesRemainingDisplay() {
    const votesEl = document.getElementById('votesRemaining');

    if (votesRemainingToday <= 0) {
      votesEl.textContent = 'No votes remaining today';
      disableVoteButtons();
    } else {
      votesEl.innerHTML = `<span>You have <strong>${votesRemainingToday}</strong> vote${votesRemainingToday !== 1 ? 's' : ''} remaining today</span>`;
    }
  }

  // ============================================================
  // UI HELPER FUNCTIONS
  // ============================================================
  function enableVoteButtons() {
    document.getElementById('voteA').disabled = false;
    document.getElementById('voteB').disabled = false;
    document.getElementById('voteTie').disabled = false;
      document.getElementById('voteBOTH_GOOD').disabled = false;
      document.getElementById('voteBOTH_BAD').disabled = false;
  }

  function disableVoteButtons() {
    { let _b = document.getElementById('voteA'); if (_b) _b.disabled = true; }
    { let _b = document.getElementById('voteB'); if (_b) _b.disabled = true; }
    { let _b = document.getElementById('voteTie'); if (_b) _b.disabled = true; }
  }

  function updateProgressBar() {
    const progress = Math.min((battlesCompleted / 10) * 100, 100);
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = battlesCompleted + ' of 10 battles this session';
  }

  function skipBattle() {
    loadNextBattle();
  }

  // ============================================================
  // CHECK AUTH ON PAGE LOAD
  // ============================================================
  window.addEventListener('load', async () => {
    const { data, error } = await supabase.auth.getSession();

    if (data?.session) {
      currentUser = data.session.user;
      await initializeArena();
    }
  });

  // Initialize Turnstile when page loads
  setTimeout(renderTurnstile, 1000);

    // IP tracking for vote integrity (#12)
    let userIpAddress = null;
    async function fetchUserIp() {
      try {
        const resp = await fetch('https://api.ipify.org?format=json');
        const data = await resp.json();
        userIpAddress = data.ip;
      } catch(e) { /* IP fetch failed, continue without it */ }
    }
    fetchUserIp();

</script>

</body>
<!-- deploy-fix-1772147793147 -->
</html>
